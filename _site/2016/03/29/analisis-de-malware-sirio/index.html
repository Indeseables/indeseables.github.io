<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Analisis de malware sirio &middot; Indeseabλes
    
  </title>

  <!-- CSS -->
  
  <link rel="stylesheet" href="/public/css/poole.css" media="none" onload="if(media!='all')media='all'">
  <noscript><link rel="stylesheet" href="poole.css"></noscript>
  <link rel="stylesheet" href="/public/css/syntax.css" media="none" onload="if(media!='all')media='all'">
  <noscript><link rel="stylesheet" href="syntax.css"></noscript>
  <link rel="stylesheet" href="/public/css/lanyon.css" media="none" onload="if(media!='all')media='all'">
  <noscript><link rel="stylesheet" href="lanyon.css"></noscript>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://i.imgsafe.org/ef6acae.png">
  <link rel="shortcut icon" href="https://i.imgsafe.org/ef6acae.png">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>



  <body>

    
    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
	    <center><img src="https://i.imgsafe.org/ef6acae.png" width="75" height="75"></img></center>
            <a href="/" title="Home">Indeseabλes</a>
            
	    &nbsp;&nbsp;&nbsp;
	    
	    <small><a href="/about">About</a></small>
	    
	    &nbsp;&nbsp;&nbsp;
	    
	    <small><a href="/archive">Entradas</a></small>
	    
	    &nbsp;&nbsp;&nbsp;
	    
	    <small><a href="/tags">Tags</a></small>
	    
	    &nbsp;&nbsp;&nbsp;
	    
	    <small><a href="/atom.xml">RSS</a></small>
	    
          </h3>
        </div>
      </div>
      <div class="container content">
        
<div class="post">
  <h1 class="post-title">Analisis de malware sirio</h1>
  <span class="post-date"> <a href="http://github.com/Blau">Blau</a>, 29 Mar 2016</span>
  <p>Ayer estuve varias horas recolectando samples para hacer mi primera entrada en el blog sobre el análisis de malware pero sólo vi keyloggers y servidores de DarkComet cifrados con crypters en .NET, así que buscando en google encontré <a href="http://syrianmalware.com/">esta página</a> y aunque el último sample es de 2014 me pareció curiosa.</p>

<p>El primer análisis es del primer sample de la web (a8ef5ccebd2e3babdd243a2861673c26). Quiero aclarar que no soy un experto en análisis así que mis procedimientos quizá no sean los más correctos.</p>

<h2 id="a8ef5ccebd2e3babdd243a2861673c26">a8ef5ccebd2e3babdd243a2861673c26</h2>
<ul>
  <li>Filename: news.exe</li>
  <li>MD5 Hash: a8ef5ccebd2e3babdd243a2861673c26</li>
  <li>Filesize: 114K</li>
  <li>Analysis or Media:
    <ul>
      <li><a href="https://docs.google.com/document/d/1LCfzNKtDwBn2BqKo_rvgCxMug8Ow-lZMBT89UFayAhI/edit?usp=sharing">Quick Analysis</a></li>
      <li><a href="https://www.virustotal.com/en/file/039058cd0f349c8987a4a61a3de12660b78007235126ee75228933fda2343e4f/analysis/1412724921/">VirusTotal Results</a></li>
      <li><a href="https://malwr.com/analysis/YTE3YWRlNjZmMjlhNGNjZmI1YmRjNDQ3YmI1MjAyZjQ/">Malwr Analysis</a></li>
    </ul>
  </li>
</ul>

<p>Un primer vistazo rápido con CFF Explorer nos muestra que es un ejecutable .NET así que veremos si se puede decompilar. Para ello usaré ILSpy ya que es el que mejor me ha funcionado en la máquina virtual. Al decompilar el ejecutable y abrimos cualquier clase vemos que parece ser que está ofuscado.
<img src="https://i.gyazo.com/f4848a908ff3b9c0e8d80aa21a055a82.png" alt="FIG1" /></p>

<p>Suerte que tenemos <a href="https://github.com/0xd4d/de4dot">de4dot</a>. Normalmente uso un par de veces de4dot por el ejecutable por si las moscas y en este caso parece ser que acerté.
<img src="https://i.gyazo.com/5d56ba4ffb3bcc74e430d09e881b84ae.png" alt="FIG2" /></p>

<p>En una de las clases vemos una variable bastante larga cifrada con Base64, seguramente un ejecutable, pero me entra la curiosidad que empiece por &lt;COMPRESSED&gt; y acabe en &lt;/COMPRESSED&gt; así que hay que buscar en el resto de clases alguna referencia a una función de compresión.
<img src="https://i.gyazo.com/8f663ac394688c72cea81f92a0c918a7.png" alt="FIG3" /></p>

<p>Encuentro a la primera la clase encargada de la compresión al ver que hay una llamada ClsCompressedString (¿seré un genio?) y una rápida búsqueda en Google me lleva a <a href="http://www.codeproject.com/Articles/27396/Easy-String-Compression-and-Encryption">esta página</a> donde seguramente el súper hacker habrá sacado el código. Creo un nuevo proyecto en VB.NET y uso la clase para descomprimir y descifrar la string usando la misma función que usa el crypter en una de sus clases. El archivo cifrado se puede descifrar con la clase clsCompressedString comentada antes, luego convirtiendo el resultado (string hexadecimal) a una array de bytes y por último descomprimiendo con GZip. El resultado es (otro) ejecutable .NET, el cual, al decompilarlo (con <a href="https://github.com/0xd4d/dnSpy">dnSpy</a>) parece ser un servidor de NjRAT 0.6.4 que conecta al DNS aliahmahhmod.zapto.org, offline en el momento de escribir el post.</p>

<h2 id="e1d84b350c1465bb4c4c77b1bcec">7263e1d84b350c1465bb4c4c77b1bcec</h2>
<ul>
  <li>Filename: برنامج الفيش.exe</li>
  <li>MD5 Hash: 7263e1d84b350c1465bb4c4c77b1bcec</li>
  <li>Filesize: 8.6M
Analysis or Media:
    <ul>
      <li><a href="https://docs.google.com/document/d/1DZvHVn1r_EOj53eYKhQ2jO4mHjR5oX1JbLoxqn-8VpM/edit?usp=sharing">Quick Analysis</a></li>
      <li><a href="https://www.virustotal.com/en/file/20c52aedfe32d4a71bf5e3353cf3999ea95b3a43c7e40c8820b1b7d24b9e6cb5/analysis/1410845347/">VirusTotal Results</a></li>
    </ul>
  </li>
</ul>

<p>CFF Explorer nos revela que es un ejecutable .NET (qué sorpresa) así que lo pasamos por de4dot, que indicará que no está ofuscado (unknown ofuscator) por eso lo decompilaré directamente. En ILSpy vemos sólo hay dos clases pero buscando en una de ellas (frmMain) vemos que en el método frmMain_Load (que se ejecutará al abrirse el formulario) hay un código para guardar un archivo en AppData con nombre ‘sql’ (niños malos).
<img src="https://i.gyazo.com/c2797d41f78a506de6c48c1512ab3048.png" alt="FIG4" /></p>

<p>ILSpy no me deja guardar el recurso así que lo abrí desde dnSpy y así lo pude guardar. Al examinar el archivo con CFF Explorer me llevé una enorme sorpresa el ver que era… otro ejecutable .NET. Al decompilar dicho ejecutable veo que sólo tiene una clase llamada Downloader así que tendré que analizarlo durante horas para saber cual es su propósito.
<img src="https://i.gyazo.com/1154346a2b7dc2ab49e3460c3d835fa7.png" alt="FIG5" /></p>

<p>Ambos archivos no están disponibles. Un punto para ellos.</p>

<h2 id="bf01f67db4a5e8e6174b066775eae0">28bf01f67db4a5e8e6174b066775eae0</h2>
<ul>
  <li>Filename: psiphon.exe</li>
  <li>MD5 Hash: 28bf01f67db4a5e8e6174b066775eae0</li>
  <li>Filesize: 1.4M</li>
  <li>Analysis or Media:
    <ul>
      <li><a href="https://citizenlab.org/2014/03/maliciously-repackaged-psiphon/">Maliciously Repackaged Psiphon Found</a></li>
      <li><a href="https://www.virustotal.com/en/file/1182ffd81b4ee9bed90ca490ca5bb258e19cce68175d1a69f054030db1075df6/analysis/">VirusTotal Results</a></li>
    </ul>
  </li>
</ul>

<p>Tercer round. CFF Explorer nos muestra que es, increíblemente, un ejecutable .NET. Ya sabéis la historia: de4dot, ILSpy/dnSpy, buscar, etc. Este ejecutable sólo tiene una clase llamada Windows que no es más que un formulario que droppea dos ejecutables desde recursos llamados server.exe (muy original…) y psiphon3.exe.</p>

<p>El ejecutable psiphon3 me pareció bastante “profesional” así que lo busqué en Google y encontré esta información en la misma <a href="https://s3.amazonaws.com/f58p-mqce-k1yj/en.html">página oficial</a>:</p>

<blockquote>
  <p>What is Psiphon 3?</p>

  <p>Psiphon 3 is a circumvention tool from Psiphon Inc. that utilizes VPN, SSH and HTTP Proxy technology to provide you with uncensored access to Internet content. Your Psiphon 3 client will automatically learn about new access points to maximize your chances of bypassing censorship.</p>

  <p>Psiphon 3 is designed to provide you with open access to online content. Psiphon does not increase your online privacy, and should not be considered or used as an online security tool.</p>
</blockquote>

<p>Así que supongo que será una herramienta auxiliar para el otro ejecutable (server.exe) que analizaré ahora.</p>

<p>Este ejecutable (.NET como no) está ofuscado con Crypto Ofuscator. Una vez decompilado… sigue estando ofuscado. de4dot no puede limpiar el ejecutable así que al mirar el código fuente no entiendo nada de nada. Tendré que tirar de análisis dinámico. Para ello usaré <a href="https://technet.microsoft.com/en-us/sysinternals/tcpview.aspx">TcpView</a> y <a href="http://www.sandboxie.com/">Sandboxie</a>.</p>

<p>Sandboxie nos revela que el ejecutable se autocopia en AppData con el nombre Explorer.exe y en la carpeta de Autoinicio con nombre chrome.exe. TcpView nos muestra que intenta conectarse a 31.9.48.141:1960.</p>

<h2 id="conclusin">Conclusión</h2>
<p>Durante estos pequeños análisis he sacado tres conclusiones:
* Los sirios aman .NET.
* Los sirios realmente aman .NET.
* Sus técnicas son bastante simples. Se sirven de crypters .NET para RATs públicos (NjRAT).</p>

<h2 id="contacto">Contacto</h2>
<ul>
  <li>Email: indeseables [at] gmail [dot] com</li>
  <li>Twitter: <a href="http://twitter.com/">@indeseables</a></li>
  <li>Issues: <a href="https://github.com/Indeseables/indeseables.github.io/issues">#Issues</a></li>
</ul>

<p><strong>Autor:</strong> <a href="https://github.com/blau72"><em>Blau</em></a></p>

<hr />

<p>Si tienes alguna duda, comentario o sugerencia, notifícanos a través de <a href="mailto:indeseables.git@gmail.com">indeseables.git@gmail.com</a>
 y si te ha gustado la entrada puedes <a href="https://twitter.com/intent/tweet?url=http://indeseables.github.io/2016/03/29/analisis-de-malware-sirio/&amp;text=Analisis de malware sirio&amp;via=indeseables!" target="_blank"> compartirla!.</a></p>

<hr />

  <div class="meta">
  <img src=https://upload.wikimedia.org/wikipedia/commons/e/e8/Game_of_life_boat.png width=30 height=30></img></span>
  <span class="author"><i><b>Autor</b></i>: Blau</br>
  <span class="email"><i><b>Email</b></i>: <a href="mailto:blau@domain.com">blau@domain.com</a> </span></br>
  <span class="github"><i><b>Git</b></i>: <a href="http://github.com/Blau">http://github.com/Blau</span>
  </div>
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2016/03/28/odisea-funcional-parte1/">
            Odisea Funcional (Parte 1)
            <small>28 Mar 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/03/27/Redes-neuronales-y-Autoencoders/">
            Redes neuronales y autoencoders.
            <small>27 Mar 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/03/25/implementacion-alternativa-algoritmos-aprendizaje/">
            Implementación alternativa de algoritmos de aprendizaje (parte I).
            <small>25 Mar 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    
  <!-- Add Disqus comments. -->
  <div id="disqus_thread" style="width:54%; margin:0 auto;"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'indeseables'; // required: replace example with your forum shortname
    var disqus_identifier = "/2016/03/29/analisis-de-malware-sirio/";

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Habilita javascript para ver los comentarios <a href="http://disqus.com/?ref_noscript">Disqus</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">Comentarios <span class="logo-disqus">Disqus</span></a>



    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-75649441-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
